<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homologador de Cargos y Salarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .step-active { border-bottom: 2px solid #2563eb; color: #2563eb; background: white; }
        .step-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen p-4 md:p-8">

    <header class="max-w-6xl mx-auto mb-8">
        <h1 class="text-3xl font-bold text-slate-900 flex items-center gap-3">
            <i data-lucide="user-check" class="text-blue-600 w-8 h-8"></i>
            Homologador de Cargos y Salarios
        </h1>
        <p class="text-slate-500 mt-2">Mapeo inteligente entre cargos de mercado y estructura interna.</p>
    </header>

    <main class="max-w-6xl mx-auto bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <!-- Navegación -->
        <div class="flex border-b border-slate-200 bg-slate-50/50">
            <button id="btn-step-upload" onclick="switchView('upload')" class="px-6 py-4 text-sm font-medium transition-colors step-active">
                1. Carga de Datos
            </button>
            <button id="btn-step-matching" onclick="switchView('matching')" class="px-6 py-4 text-sm font-medium transition-colors step-inactive" disabled>
                2. Revisión de Homologación
            </button>
        </div>

        <!-- Vista de Carga -->
        <div id="view-upload" class="p-8 space-y-8">
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Mercado -->
                <div class="space-y-4">
                    <h3 class="font-semibold flex items-center gap-2">
                        <i data-lucide="file-text" class="text-blue-500 w-5 h-5"></i>
                        Hoja "CONSOLIDADO" (Mercado)
                    </h3>
                    <p class="text-xs text-slate-500">Copia las celdas de Excel (con encabezados) y pégalas abajo.</p>
                    <textarea id="paste-market" class="w-full h-40 p-3 text-xs border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="Pegue aquí los datos de mercado..."></textarea>
                    <div id="market-status" class="text-xs text-emerald-600 hidden flex items-center gap-1">
                        <i data-lucide="check" class="w-3 h-3"></i> <span id="market-count">0</span> registros listos.
                    </div>
                </div>

                <!-- Interno -->
                <div class="space-y-4">
                    <h3 class="font-semibold flex items-center gap-2">
                        <i data-lucide="user-check" class="text-emerald-500 w-5 h-5"></i>
                        Hoja "Cargos Comfamiliar"
                    </h3>
                    <p class="text-xs text-slate-500">Copia las celdas con Cargo y Sueldo Base y pégalas abajo.</p>
                    <textarea id="paste-internal" class="w-full h-40 p-3 text-xs border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="Pegue aquí los cargos internos..."></textarea>
                    <div id="internal-status" class="text-xs text-emerald-600 hidden flex items-center gap-1">
                        <i data-lucide="check" class="w-3 h-3"></i> <span id="internal-count">0</span> cargos listos.
                    </div>
                </div>
            </div>

            <div class="pt-4 flex justify-center">
                <button id="btn-process" onclick="autoMatch()" class="px-8 py-3 bg-blue-600 text-white rounded-xl font-semibold shadow-lg shadow-blue-200 hover:bg-blue-700 disabled:bg-slate-300 disabled:shadow-none transition-all flex items-center gap-2" disabled>
                    Iniciar Homologación Automática
                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Vista de Matching -->
        <div id="view-matching" class="hidden">
            <div class="bg-blue-50 p-4 border-b border-blue-100 flex justify-between items-center">
                <div class="flex items-center gap-2 text-blue-700">
                    <i data-lucide="info" class="w-5 h-5"></i>
                    <span class="text-sm font-medium">Revisa las sugerencias y ajusta donde sea necesario.</span>
                </div>
                <button onclick="exportData()" class="flex items-center gap-2 px-4 py-2 bg-white text-blue-600 border border-blue-200 rounded-lg text-sm font-bold hover:bg-blue-50">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Exportar a Excel/Sheets
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider">
                            <th class="px-6 py-4 border-b font-semibold">Cargo Mercado</th>
                            <th class="px-6 py-4 border-b font-semibold">Misión / Descripción</th>
                            <th class="px-6 py-4 border-b font-semibold">Cargo Homologado (Interno)</th>
                            <th class="px-6 py-4 border-b text-center font-semibold">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="matching-body" class="text-sm divide-y divide-slate-100">
                        <!-- Se llena dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="max-w-6xl mx-auto mt-8 text-center text-slate-400 text-xs">
        * El sistema utiliza comparación semántica para sugerir el cargo interno basado en el nombre y la misión del cargo de mercado.
    </footer>

    <script>
        let marketData = [];
        let internalPositions = [];
        let mappings = {};

        // Inicializar iconos
        lucide.createIcons();

        // Cálculo de similitud
        function calculateSimilarity(str1, str2) {
            const s1 = (str1 || "").toLowerCase().trim();
            const s2 = (str2 || "").toLowerCase().trim();
            if (s1 === s2) return 1;
            const words1 = s1.split(/\s+/);
            const words2 = s2.split(/\s+/);
            const intersection = words1.filter(word => words2.includes(word));
            return intersection.length / Math.max(words1.length, words2.length);
        }

        // Manejar Pegado
        function processPaste(type, text) {
            const rows = text.trim().split('\n').map(row => row.split('\t'));
            const headers = rows[0].map(h => h.trim());
            const data = rows.slice(1).map(row => {
                let obj = {};
                headers.forEach((h, i) => obj[h] = row[i]);
                return obj;
            });

            if (type === 'market') {
                marketData = data;
                document.getElementById('market-count').innerText = data.length;
                document.getElementById('market-status').classList.remove('hidden');
                document.getElementById('paste-market').value = `✓ ${data.length} registros cargados correctamente.`;
                document.getElementById('paste-market').disabled = true;
            } else {
                internalPositions = data;
                document.getElementById('internal-count').innerText = data.length;
                document.getElementById('internal-status').classList.remove('hidden');
                document.getElementById('paste-internal').value = `✓ ${data.length} cargos cargados correctamente.`;
                document.getElementById('paste-internal').disabled = true;
            }

            checkProcessAvailability();
        }

        document.getElementById('paste-market').addEventListener('paste', (e) => {
            setTimeout(() => processPaste('market', e.target.value), 10);
        });

        document.getElementById('paste-internal').addEventListener('paste', (e) => {
            setTimeout(() => processPaste('internal', e.target.value), 10);
        });

        function checkProcessAvailability() {
            if (marketData.length > 0 && internalPositions.length > 0) {
                document.getElementById('btn-process').disabled = false;
                document.getElementById('btn-step-matching').disabled = false;
            }
        }

        function switchView(view) {
            const uploadView = document.getElementById('view-upload');
            const matchingView = document.getElementById('view-matching');
            const btnUpload = document.getElementById('btn-step-upload');
            const btnMatching = document.getElementById('btn-step-matching');

            if (view === 'upload') {
                uploadView.classList.remove('hidden');
                matchingView.classList.add('hidden');
                btnUpload.className = "px-6 py-4 text-sm font-medium transition-colors step-active";
                btnMatching.className = "px-6 py-4 text-sm font-medium transition-colors step-inactive";
            } else {
                uploadView.classList.add('hidden');
                matchingView.classList.remove('hidden');
                btnUpload.className = "px-6 py-4 text-sm font-medium transition-colors step-inactive";
                btnMatching.className = "px-6 py-4 text-sm font-medium transition-colors step-active";
            }
        }

        function autoMatch() {
            mappings = {};
            marketData.forEach((mItem, mIndex) => {
                let bestMatch = "";
                let maxScore = -1;

                internalPositions.forEach((iItem) => {
                    const scoreCargo = calculateSimilarity(mItem.Cargo, iItem.Cargo);
                    const scoreMision = calculateSimilarity(mItem.Misión, iItem.Cargo);
                    const finalScore = (scoreCargo * 0.7) + (scoreMision * 0.3);

                    if (finalScore > maxScore) {
                        maxScore = finalScore;
                        bestMatch = iItem.Cargo;
                    }
                });

                if (maxScore > 0.15) {
                    mappings[mIndex] = bestMatch;
                }
            });

            renderTable();
            switchView('matching');
        }

        function renderTable() {
            const body = document.getElementById('matching-body');
            body.innerHTML = '';

            marketData.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50/50 transition-colors";
                
                const options = internalPositions.map(pos => 
                    `<option value="${pos.Cargo}" ${mappings[idx] === pos.Cargo ? 'selected' : ''}>${pos.Cargo}</option>`
                ).join('');

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium">
                        <div class="text-slate-900">${item.Cargo || 'N/A'}</div>
                        <div class="text-[10px] text-slate-400">Estudios: ${item.Estudios || '-'}</div>
                    </td>
                    <td class="px-6 py-4 text-slate-500 text-xs max-w-xs truncate" title="${item.Misión || ''}">
                        ${item.Misión || "Sin misión definida"}
                    </td>
                    <td class="px-6 py-4">
                        <select onchange="updateMapping(${idx}, this.value)" class="w-full p-2 bg-white border border-slate-200 rounded text-xs focus:ring-1 focus:ring-blue-500 outline-none">
                            <option value="">Seleccionar cargo...</option>
                            ${options}
                        </select>
                    </td>
                    <td class="px-6 py-4 text-center" id="status-${idx}">
                        ${mappings[idx] ? '<i data-lucide="check-circle" class="text-emerald-500 mx-auto w-5 h-5"></i>' : '<div class="w-2 h-2 rounded-full bg-amber-400 mx-auto"></div>'}
                    </td>
                `;
                body.appendChild(tr);
            });
            lucide.createIcons();
        }

        function updateMapping(idx, value) {
            mappings[idx] = value;
            const statusCell = document.getElementById(`status-${idx}`);
            if (value) {
                statusCell.innerHTML = '<i data-lucide="check-circle" class="text-emerald-500 mx-auto w-5 h-5"></i>';
            } else {
                statusCell.innerHTML = '<div class="w-2 h-2 rounded-full bg-amber-400 mx-auto"></div>';
            }
            lucide.createIcons();
        }

        function exportData() {
            if (marketData.length === 0) return;
            
            const headers = [...Object.keys(marketData[0]), "Homologado"];
            let csvContent = headers.join('\t') + '\n';

            marketData.forEach((item, idx) => {
                const row = [...Object.values(item), mappings[idx] || ""];
                csvContent += row.join('\t') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/tab-separated-values' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Estudio_Salarial_Homologado.tsv';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>